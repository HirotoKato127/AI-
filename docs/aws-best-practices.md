# AWS 開発・運用ベストプラクティス

> AWSを使う開発会社が「当たり前にやっていること」をまとめたガイド。
> AWS公式の [Well-Architected Framework](https://aws.amazon.com/architecture/well-architected/) の5本柱を実務レベルに噛み砕いたもの。

---

## 全体像: AWSの「5本柱」

AWSは「良いシステム」を5つの観点で定義している。

```
┌──────────────────────────────────────────────┐
│           Well-Architected Framework          │
├──────────┬──────────┬──────────┬──────────┬───┤
│ セキュリティ │  信頼性  │ パフォーマンス │ コスト最適化 │ 運用 │
│ Security │Reliability│Performance│  Cost   │ Ops│
└──────────┴──────────┴──────────┴──────────┴───┘
```

---

## 柱1: セキュリティ 🔒

> 「データを守る。アクセスを制御する。何が起きたか追跡する。」

### 1-1. IAM（誰が何をできるか）

| ルール | なぜ | 重要度 |
|---|---|---|
| **ルートアカウントを日常使用しない** | 全権限を持つため、漏洩時の被害が甚大 | 🔴 必須 |
| **ルートにMFA（多要素認証）を設定** | パスワードだけでは不十分 | 🔴 必須 |
| **IAMユーザーは1人1アカウント** | 共有すると「誰がやったか」分からなくなる | 🔴 必須 |
| **最小権限の原則** | 必要な操作だけ許可。「とりあえずAdmin」は危険 | 🔴 必須 |
| **アクセスキーは定期ローテーション** | 漏洩した場合のリスクを最小化 | 🟡 推奨 |

#### よくある失敗例

```
❌ 開発者全員に AdministratorAccess を付与
❌ 1つのIAMアカウントを全員で共有
❌ アクセスキーを作ったまま1年放置
❌ ルートアカウントでLambdaをデプロイ
```

### 1-2. シークレット管理

| ルール | なぜ | 重要度 |
|---|---|---|
| **パスワード・APIキーをコードに書かない** | Gitに残ると全員に見える | 🔴 必須 |
| **Secrets ManagerかSSM Parameter Storeを使う** | 暗号化・ローテーションが自動でできる | 🔴 必須 |
| **Lambda環境変数でのシークレット管理は非推奨** | コンソールから丸見え | 🟡 推奨 |
| **.envファイルはGitにコミットしない** | 漏洩の原因No.1 | 🔴 必須 |

### 1-3. ネットワーク

| ルール | なぜ | 重要度 |
|---|---|---|
| **DBはプライベートサブネットに置く** | インターネットから直接アクセス不可にする | 🔴 必須 |
| **セキュリティグループは最小ポートのみ開放** | 不要なポートは攻撃対象になる | 🔴 必須 |
| **0.0.0.0/0 への開放は原則禁止** | 全世界からアクセス可能になる | 🔴 必須 |
| **通信はTLS/SSLで暗号化** | 盗聴を防ぐ | 🟡 推奨 |

### 1-4. ログ・監査

| ルール | なぜ | 重要度 |
|---|---|---|
| **CloudTrailを有効にする** | 「誰が・いつ・何をしたか」を記録 | 🔴 必須 |
| **ログにパスワードやカード番号を出力しない** | ログは開発者全員が見られるため | 🔴 必須 |
| **GuardDutyで脅威検知** | 不審なアクセスを自動検知 | 🟡 推奨 |

---

## 柱2: 信頼性 🏗️

> 「壊れても復旧できる。データを失わない。」

### 2-1. バックアップ

| ルール | なぜ | 重要度 |
|---|---|---|
| **本番DBは毎日自動バックアップ** | データ消失を防ぐ | 🔴 必須 |
| **保持期間を設定する（7〜14日）** | 無限に溜まるとコストが膨らむ | 🔴 必須 |
| **年1回はバックアップからの復旧テスト** | いざという時に使えないと意味がない | 🟡 推奨 |
| **重要な変更前に手動スナップショット** | マイグレーション失敗時のセーフティネット | 🔴 必須 |

### 2-2. 冗長化

| ルール | なぜ | 重要度 |
|---|---|---|
| **Multi-AZは本番のみ** | 開発でやると無駄にコスト2倍 | 🟡 推奨 |
| **RDS削除保護を本番で有効化** | うっかり消すのを防ぐ | 🔴 必須 |
| **障害時の復旧手順を文書化しておく** | パニック時に手順があると安心 | 🟡 推奨 |

---

## 柱3: パフォーマンス ⚡

> 「適切なサイズで、無駄なく速く。」

### 3-1. サイジング

| ルール | なぜ | 重要度 |
|---|---|---|
| **小さく始めて必要に応じてスケールアップ** | 最初から大きいとコストが無駄 | 🔴 必須 |
| **Lambda メモリは128MBから始める** | 128MB→256MBで速度2倍になることも | 🟡 推奨 |
| **RDSは利用状況を見てインスタンス変更** | CloudWatchのCPU/メモリを定期確認 | 🟡 推奨 |

### 3-2. キャッシュ

| ルール | なぜ | 重要度 |
|---|---|---|
| **静的コンテンツにCDN（CloudFront）を使う** | ユーザーに近い場所から配信 | 🟡 推奨 |
| **API Gatewayのキャッシュを検討** | 同じリクエストへの応答を高速化 | 🟢 任意 |

---

## 柱4: コスト最適化 💰

> 「使った分だけ払う。使ってないものは消す。」

### 4-1. 日常管理

| ルール | なぜ | 重要度 |
|---|---|---|
| **月1回コストレビュー（Cost Explorer）** | 異常課金を早期発見 | 🔴 必須 |
| **予算アラートを設定する** | 閾値を超えたら通知が来る | 🔴 必須 |
| **テスト用リソースはその日のうちに消す** | 放置すると雪だるま式に課金 | 🔴 必須 |
| **全リソースにNameタグを付ける** | 「これ何？」を防ぐ | 🔴 必須 |

### 4-2. 見落としがちな課金ポイント

開発会社でよく見落とされるコスト。知らないと毎月お金が溶ける。

| サービス | 課金の仕組み | 見落としポイント |
|---|---|---|
| **RDS** | インスタンス時間+ストレージ | **止められない**（EC2と違って停止しても7日後に自動起動） |
| **NAT Gateway** | 時間+データ量 | 存在するだけで **月$45+** |
| **Elastic IP** | 未使用時に課金 | EC2停止中のEIPは **月$3.65** |
| **EBSボリューム** | 使用/未使用問わず課金 | 未アタッチでも **GB × $0.12/月** |
| **Aurora Serverless** | ACU × 時間 | 最小でも **$0.10/ACU/時** |
| **RDS Proxy** | vCPU × 時間 | 存在するだけで **月$22+** |
| **CloudWatch Logs** | 取り込み+保持 | 保持期間が無限だと永遠に膨らむ |
| **スナップショット** | GB × $0.095/月 | 数が増えると本体より高くなる |
| **VPCエンドポイント** | 1個あたり **月$7+** | 不要なのに残りがち |
| **AWS Backup** | 頻度×保持期間 | 3時間ごと14日だと大量に溜まる |

### 4-3. コスト確認コマンド

```bash
# 今月のサービス別コストを確認
aws ce get-cost-and-usage \
  --time-period Start=2026-02-01,End=2026-03-01 \
  --granularity MONTHLY \
  --metrics "UnblendedCost" \
  --group-by Type=DIMENSION,Key=SERVICE \
  --query "ResultsByTime[0].Groups[?to_number(Metrics.UnblendedCost.Amount) > \`1\`].\
{Service:Keys[0],Cost:Metrics.UnblendedCost.Amount}" \
  --output table

# 使用タイプ別の詳細（何が高いか深掘り）
aws ce get-cost-and-usage \
  --time-period Start=2026-02-01,End=2026-03-01 \
  --granularity MONTHLY \
  --metrics "UnblendedCost" \
  --group-by Type=DIMENSION,Key=USAGE_TYPE \
  --query "ResultsByTime[0].Groups[?to_number(Metrics.UnblendedCost.Amount) > \`1\`].\
{Type:Keys[0],Cost:Metrics.UnblendedCost.Amount}" \
  --output table
```

---

## 柱5: 運用の優秀性 🔧

> 「手作業を減らす。変更を安全に行う。振り返りを怠らない。」

### 5-1. インフラ管理

| ルール | なぜ | 重要度 |
|---|---|---|
| **リージョンを統一する（東京推奨）** | バラバラだと管理が困難 | 🔴 必須 |
| **IaC（CloudFormation/Terraform）を検討** | 手作業はミスの元 | 🟡 推奨 |
| **変更履歴を残す** | 「誰がいつ何を変えたか」を追跡 | 🔴 必須 |

### 5-2. デプロイ

| ルール | なぜ | 重要度 |
|---|---|---|
| **dev環境で検証してからprod** | 本番で初テストは事故の元 | 🔴 必須 |
| **本番は直接変更しない** | 必ずGit + CI/CD 経由で | 🔴 必須 |
| **金曜夕方にデプロイしない** | 問題発生時に週末対応になる | 🟡 推奨 |
| **デプロイ後に動作確認** | 問題を早期発見 | 🔴 必須 |

### 5-3. ドキュメント

| ルール | なぜ | 重要度 |
|---|---|---|
| **システム構成図を最新に保つ** | 新メンバーのオンボーディング用 | 🟡 推奨 |
| **障害対応手順を文書化** | パニック時に冷静に対応 | 🟡 推奨 |
| **月次運用レポートを作成** | コスト・ログ・障害の傾向を把握 | 🟢 任意 |

---

## はじめの一歩（最低限やるべき5つ）

新しくAWSを使い始めるチームが、**まず最初にやるべき5つ**：

```
1. ルートアカウントにMFAを設定する
2. IAMユーザーを個人ごとに作る（AdministratorAccessを使わない）
3. 月$300の予算アラートを設定する
4. CloudTrailをONにする
5. RDSのパブリックアクセスをOFFにする
```

この5つだけで、**セキュリティ事故の8割**と**コスト事故の5割**を防げる。

---

## うちの現状との比較

| ベストプラクティス | うちの現状 | 対応 |
|---|---|---|
| シークレットはSecrets Managerに | ❌ Lambda環境変数に平文 | 要対応 |
| テストリソースは即日削除 | ❌ Aurora23日間放置→$1,776 | 済（2/24削除） |
| Nameタグ必須 | ❌ 無名EC2が存在 | 要対応 |
| リージョン統一 | ❌ 東京+大阪+シドニーに分散 | 要整理 |
| 月次コストレビュー | ❌ 未実施 | 要対応 |
| RDSパブリックアクセスOFF | ❌ 有効のまま | 要対応 |
| 予算アラート | ❌ 未設定 | 要対応 |
| CloudTrail有効化 | 未確認 | 要確認 |
| ログ保持期間設定 | ❌ 無制限の可能性 | 要確認 |
| PRレビュー必須 | ✅ PRベースの開発 | OK |
